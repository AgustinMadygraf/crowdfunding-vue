name: deploy-vue-to-ferozo

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      enable_debug_http:
        description: "Habilitar logs HTTP de depuracion (VITE_DEBUG_HTTP)"
        required: false
        default: "false"

concurrency:
  group: deploy-vue
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node (with npm cache)
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Validar config requerida
        shell: bash
        env:
          FTP_SERVER: ${{ vars.FTP_SERVER }}
          FTP_SERVER_IP: ${{ vars.FTP_SERVER_IP }}
          FTP_PORT: ${{ vars.FTP_PORT }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          VITE_CHATWOOT_TOKEN: ${{ vars.VITE_CHATWOOT_TOKEN }}
          VITE_CHATWOOT_BASE_URL: ${{ vars.VITE_CHATWOOT_BASE_URL }}
          VITE_CHATWOOT_INBOX_IDENTIFIER: ${{ vars.VITE_CHATWOOT_INBOX_IDENTIFIER }}
          VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL }}
          VITE_GOOGLE_CLIENT_ID: ${{ vars.VITE_GOOGLE_CLIENT_ID }}
        run: |
          set -euo pipefail

          # Validar variables obligatorias
          for v in FTP_USERNAME FTP_PASSWORD VITE_CHATWOOT_TOKEN VITE_CHATWOOT_BASE_URL VITE_CHATWOOT_INBOX_IDENTIFIER VITE_API_BASE_URL VITE_GOOGLE_CLIENT_ID; do
            if [ -z "${!v:-}" ]; then
              echo "::error::Falta $v (requerido para producción)"
              exit 1
            fi
          done

          echo "::notice::Variables obligatorias validadas ✓"

          if [ -z "${FTP_SERVER:-}" ]; then
            echo "::error::Falta FTP_SERVER (var). Ej: vps-5455262-x.dattaweb.com"
            exit 1
          fi

          echo "FTP_PORT=${FTP_PORT:-21}" >> "$GITHUB_ENV"

      - name: Resolver IP (forzar IPv4) y armar URL de conexión
        shell: bash
        env:
          FTP_SERVER: ${{ vars.FTP_SERVER }}
          FTP_SERVER_IP: ${{ vars.FTP_SERVER_IP }}
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y dnsutils lftp

          ip4="$(dig +short "$FTP_SERVER" A | head -n 1 || true)"
          if [ -z "$ip4" ] && [ -n "${FTP_SERVER_IP:-}" ]; then
            ip4="$FTP_SERVER_IP"
            echo "::notice::No encontré A record; usando FTP_SERVER_IP fallback: $ip4"
          fi

          if [ -z "$ip4" ]; then
            echo "::error::No pude obtener IPv4 (A). Cargá FTP_SERVER_IP (ej: 200.58.103.24)."
            exit 1
          fi

          echo "FTP_IPv4_EFFECTIVE=$ip4" >> "$GITHUB_ENV"
          echo "FTP_CONNECT_URL=ftp://${ip4}:${FTP_PORT}" >> "$GITHUB_ENV"
          echo "::notice::FTP_CONNECT_URL=ftp://${ip4}:${FTP_PORT}"

      - name: Preflight puerto 21 (IPv4)
        shell: bash
        run: |
          set -euo pipefail
          nc -zv "$FTP_IPv4_EFFECTIVE" "$FTP_PORT"

      - name: Instalar dependencias
        run: npm ci

      - name: Build
        env:
          VITE_CHATWOOT_TOKEN: ${{ vars.VITE_CHATWOOT_TOKEN }}
          VITE_CHATWOOT_BASE_URL: ${{ vars.VITE_CHATWOOT_BASE_URL }}
          VITE_CHATWOOT_INBOX_IDENTIFIER: ${{ vars.VITE_CHATWOOT_INBOX_IDENTIFIER }}
          VITE_CHATWOOT_SDK_INTEGRITY: ${{ vars.VITE_CHATWOOT_SDK_INTEGRITY }}
          VITE_GOOGLE_CLIENT_ID: ${{ vars.VITE_GOOGLE_CLIENT_ID }}
          VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL }}
          VITE_SITE_URL: ${{ vars.VITE_SITE_URL }}
          VITE_MERCADOPAGO_PUBLIC_KEY: ${{ vars.VITE_MERCADOPAGO_PUBLIC_KEY }}
          VITE_DEBUG_HTTP: ${{ github.event.inputs.enable_debug_http || 'false' }}
        run: npm run build

      - name: Validar dist antes de deploy
        shell: bash
        run: |
          set -euo pipefail

          if [ ! -f "dist/index.html" ]; then
            echo "::error::Falta dist/index.html. El build no generó artefacto válido."
            exit 1
          fi

          dist_size_bytes="$(du -sb dist | cut -f1)"
          if [ "$dist_size_bytes" -lt 10240 ]; then
            echo "::error::dist tiene tamaño inesperadamente bajo (${dist_size_bytes} bytes)."
            exit 1
          fi

          echo "::notice::dist validado (${dist_size_bytes} bytes)"

      - name: Ensure dist/assets folder exists
        run: mkdir -p dist/assets

      - name: Copiar .htaccess versionado al dist
        shell: bash
        run: |
          set -euo pipefail

          if [ ! -f "public/.htaccess" ]; then
            echo "::error::Falta public/.htaccess versionado en el repositorio."
            exit 1
          fi

          cp public/.htaccess dist/.htaccess

      - name: Deploy con lftp mirror (dist -> /public_html/crowdfunding) [IPv4 + excludes]
        shell: bash
        env:
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          set -euo pipefail
          # Debug: muestra la URL de conexion (sin credenciales)
          echo "::notice::Conectando a: $FTP_CONNECT_URL (destino: /public_html/crowdfunding)"
          echo "::notice::Tamaño de dist/: $(du -sh dist/ | cut -f1)"

          lftp -u "$FTP_USERNAME","$FTP_PASSWORD" "$FTP_CONNECT_URL" <<'EOF'
          set cmd:fail-exit true
          set net:timeout 180
          set net:max-retries 10
          set net:reconnect-interval-base 15
          set net:reconnect-interval-multiplier 1
          set net:idle 240
          set ftp:passive-mode on
          set ftp:ssl-allow no
          set ftp:prefer-epsv no
          set ftp:sync-mode off
          set dns:order "inet"

          # Mirror directo, sincroniza y elimina archivos obsoletos
          echo "Iniciando sincronización..."
          mirror -R --delete --verbose --no-perms \
            --exclude-glob .ht_leame \
            --exclude-glob cgi-bin/ \
            dist/ /public_html/crowdfunding/

          echo "Proceso finalizado"
          bye
          EOF
          
          echo "::notice::Comando lftp ejecutado"

      - name: Deploy smoke check (opcional)
        if: ${{ vars.DEPLOY_HEALTHCHECK_URL != '' }}
        shell: bash
        env:
          DEPLOY_HEALTHCHECK_URL: ${{ vars.DEPLOY_HEALTHCHECK_URL }}
        run: |
          set -euo pipefail

          status_code="$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOY_HEALTHCHECK_URL")"
          if ! [[ "$status_code" =~ ^(200|301|302)$ ]]; then
            echo "::error::Smoke check falló para $DEPLOY_HEALTHCHECK_URL (status: $status_code)"
            exit 1
          fi

          echo "::notice::Smoke check OK ($status_code): $DEPLOY_HEALTHCHECK_URL"
