name: deploy-vue-to-ferozo

on:
  push:
    branches: [ main ]

concurrency:
  group: deploy-vue
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node (with npm cache)
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # âœ… ValidaciÃ³n temprana (sin exponer secrets a todo el job)
      - name: Validar secrets requeridos y formato
        shell: bash
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_DIR: ${{ secrets.FTP_DIR }}
        run: |
          set -euo pipefail

          missing=0
          for v in FTP_SERVER FTP_USERNAME FTP_PASSWORD FTP_DIR; do
            if [ -z "${!v:-}" ]; then
              echo "::error::Falta el secreto $v"
              missing=1
            fi
          done
          if [ "$missing" -eq 1 ]; then exit 1; fi

          # Validaciones de formato para FTP_SERVER
          if [[ "$FTP_SERVER" == *"://"* ]]; then
            echo "::error::FTP_SERVER no debe incluir protocolo (ftp:// o ftps://)"
            exit 1
          fi
          if [[ "$FTP_SERVER" == *"/"* ]]; then
            echo "::error::FTP_SERVER no debe incluir path (solo host o IP)"
            exit 1
          fi
          if [[ "$FTP_SERVER" == *":"* ]]; then
            echo "::error::FTP_SERVER no debe incluir puerto (ej :21)"
            exit 1
          fi
          if [[ "$FTP_SERVER" =~ [[:space:]] ]]; then
            echo "::error::FTP_SERVER contiene espacios/saltos de lÃ­nea"
            exit 1
          fi

      # âœ… Chequeo REAL: autentica y verifica permisos en FTP_DIR (fail-fast por credenciales)
      - name: Chequear login FTP y acceso a FTP_DIR
        shell: bash
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_DIR: ${{ secrets.FTP_DIR }}
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y lftp

          # Nota: esto prueba FTP (no FTPS/SFTP). Si tu hosting requiere FTPS/SFTP, hay que ajustar.
          lftp -u "$FTP_USERNAME","$FTP_PASSWORD" "$FTP_SERVER" <<EOF
          set net:max-retries 1
          set net:timeout 10
          set cmd:fail-exit true
          cd "$FTP_DIR"
          ls
          bye
          EOF

      - name: Instalar dependencias
        run: npm ci

      - name: Build
        run: npm run build

      - name: Ensure dist/assets folder exists
        run: mkdir -p dist/assets

      # âœ… No pisa un .htaccess que ya venga del repo/build
      - name: Ensure .htaccess for SPA (history mode)
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f "dist/.htaccess" ]; then
            cat > "dist/.htaccess" <<'EOF'
          # SPA fallback (history mode)
          RewriteEngine On
          RewriteRule ^index\.html$ - [L]
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteRule . /index.html [L]
          EOF
          fi

      # ðŸ”Ž Debug de red (sin imprimir secretos)
      - name: Debug DNS y conectividad (sin exponer valores)
        shell: bash
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
        run: |
          set -euo pipefail
          echo "Resolviendo host (oculto)"
          nslookup "$FTP_SERVER" || true
          echo "Probando puerto 21"
          nc -zv "$FTP_SERVER" 21 || true

      - name: Deploy dist via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: dist/
          server-dir: ${{ secrets.FTP_DIR }}/
          log-level: minimal
          timeout: 60000
