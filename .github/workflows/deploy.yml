name: deploy-vue-to-ferozo

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      enable_debug_http:
        description: "Habilitar logs HTTP de depuracion (VITE_DEBUG_HTTP)"
        required: false
        default: "false"

concurrency:
  group: deploy-vue
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build-typecheck:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Setup Node (with npm cache)
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: "20"
          cache: "npm"

      - name: Instalar dependencias
        run: npm ci

      - name: Type check
        run: npm run type-check

  build-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Setup Node (with npm cache)
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: "20"
          cache: "npm"

      - name: Instalar dependencias
        run: npm ci

      - name: Tests
        run: npm run test -- --run

  build-package:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [build-typecheck, build-test]

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Setup Node (with npm cache)
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: "20"
          cache: "npm"

      - name: Validar config de build requerida
        shell: bash
        env:
          VITE_CHATWOOT_TOKEN: ${{ vars.VITE_CHATWOOT_TOKEN }}
          VITE_CHATWOOT_BASE_URL: ${{ vars.VITE_CHATWOOT_BASE_URL }}
          VITE_CHATWOOT_INBOX_IDENTIFIER: ${{ vars.VITE_CHATWOOT_INBOX_IDENTIFIER }}
          VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL }}
          VITE_GOOGLE_CLIENT_ID: ${{ vars.VITE_GOOGLE_CLIENT_ID }}
        run: |
          set -euo pipefail

          for v in VITE_CHATWOOT_TOKEN VITE_CHATWOOT_BASE_URL VITE_CHATWOOT_INBOX_IDENTIFIER VITE_API_BASE_URL VITE_GOOGLE_CLIENT_ID; do
            if [ -z "${!v:-}" ]; then
              echo "::error::Falta $v (requerido para build)"
              exit 1
            fi
          done

          echo "::notice::Variables de build validadas"

      - name: Instalar dependencias
        run: npm ci

      - name: Build package only
        env:
          VITE_CHATWOOT_TOKEN: ${{ vars.VITE_CHATWOOT_TOKEN }}
          VITE_CHATWOOT_BASE_URL: ${{ vars.VITE_CHATWOOT_BASE_URL }}
          VITE_CHATWOOT_INBOX_IDENTIFIER: ${{ vars.VITE_CHATWOOT_INBOX_IDENTIFIER }}
          VITE_CHATWOOT_SDK_INTEGRITY: ${{ vars.VITE_CHATWOOT_SDK_INTEGRITY }}
          VITE_GOOGLE_CLIENT_ID: ${{ vars.VITE_GOOGLE_CLIENT_ID }}
          VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL }}
          VITE_SITE_URL: ${{ vars.VITE_SITE_URL }}
          VITE_MERCADOPAGO_PUBLIC_KEY: ${{ vars.VITE_MERCADOPAGO_PUBLIC_KEY }}
          VITE_DEBUG_HTTP: ${{ github.event.inputs.enable_debug_http || 'false' }}
        run: npm run build-only

      - name: Validar dist antes de deploy
        shell: bash
        run: |
          set -euo pipefail

          if [ ! -f "dist/index.html" ]; then
            echo "::error::Falta dist/index.html. El build no generÃ³ artefacto vÃ¡lido."
            exit 1
          fi

          dist_size_bytes="$(du -sb dist | cut -f1)"
          if [ "$dist_size_bytes" -lt 10240 ]; then
            echo "::error::dist tiene tamaÃ±o inesperadamente bajo (${dist_size_bytes} bytes)."
            exit 1
          fi

          echo "::notice::dist validado (${dist_size_bytes} bytes)"

      - name: Ensure dist/assets folder exists
        run: mkdir -p dist/assets

      - name: Copiar .htaccess versionado al dist
        shell: bash
        run: |
          set -euo pipefail

          if [ ! -f "public/.htaccess" ]; then
            echo "::error::Falta public/.htaccess versionado en el repositorio."
            exit 1
          fi

          cp public/.htaccess dist/.htaccess

      - name: Smoke test funcional (preview local)
        shell: bash
        run: |
          set -euo pipefail
          bash scripts/smoke-test-preview.sh

      - name: Upload artifact dist
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: app-dist
          path: dist
          if-no-files-found: error
          retention-days: 1

  deploy-release:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: build-package
    environment:
      name: production

    steps:
      - name: Download artifact dist
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: app-dist
          path: dist

      - name: Validar config de deploy requerida
        shell: bash
        env:
          FTP_SERVER: ${{ vars.FTP_SERVER }}
          FTP_PORT: ${{ vars.FTP_PORT }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          set -euo pipefail

          for v in FTP_USERNAME FTP_PASSWORD; do
            if [ -z "${!v:-}" ]; then
              echo "::error::Falta $v (requerido para deploy)"
              exit 1
            fi
          done

          if [ -z "${FTP_SERVER:-}" ]; then
            echo "::error::Falta FTP_SERVER (var). Ej: vps-5455262-x.dattaweb.com"
            exit 1
          fi

          echo "FTP_PORT=${FTP_PORT:-21}" >> "$GITHUB_ENV"
          echo "::notice::Credenciales/vars de deploy validadas"

      - name: Resolver IP (forzar IPv4) y armar URL de conexión
        shell: bash
        env:
          FTP_SERVER: ${{ vars.FTP_SERVER }}
          FTP_SERVER_IP: ${{ vars.FTP_SERVER_IP }}
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y dnsutils lftp

          ip4="$(dig +short "$FTP_SERVER" A | head -n 1 || true)"
          if [ -z "$ip4" ] && [ -n "${FTP_SERVER_IP:-}" ]; then
            ip4="$FTP_SERVER_IP"
            echo "::notice::No encontré A record; usando FTP_SERVER_IP fallback: $ip4"
          fi

          if [ -z "$ip4" ]; then
            echo "::error::No pude obtener IPv4 (A). Cargá FTP_SERVER_IP (ej: 200.58.103.24)."
            exit 1
          fi

          echo "FTP_IPv4_EFFECTIVE=$ip4" >> "$GITHUB_ENV"
          echo "FTP_HOST_EFFECTIVE=$ip4" >> "$GITHUB_ENV"
          echo "::notice::Host IPv4 efectivo: ${ip4}:${FTP_PORT}"

      - name: Preflight puerto FTP (IPv4)
        shell: bash
        run: |
          set -euo pipefail
          nc -zv "$FTP_IPv4_EFFECTIVE" "$FTP_PORT"

      - name: Diagnostico de protocolos cifrados (SFTP/FTPS)
        shell: bash
        env:
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          set -euo pipefail

          host="$FTP_IPv4_EFFECTIVE"
          ftp_port="${FTP_PORT:-21}"

          echo "::group::Diagnostico de conectividad"
          if nc -z -w 5 "$host" 22 >/dev/null 2>&1; then
            echo "::notice::Puerto 22 abierto (candidato SFTP)"
          else
            echo "::warning::Puerto 22 cerrado o filtrado (SFTP improbable)"
          fi

          if nc -z -w 5 "$host" 990 >/dev/null 2>&1; then
            echo "::notice::Puerto 990 abierto (candidato FTPS implicito)"
          else
            echo "::notice::Puerto 990 cerrado (FTPS implicito no evidente)"
          fi
          echo "::endgroup::"

          echo "::group::Handshake FTPS explicito (AUTH TLS sobre 21)"
          if timeout 10 openssl s_client -starttls ftp -connect "${host}:${ftp_port}" < /dev/null > /tmp/ftps-explicit.log 2>&1; then
            echo "::notice::Handshake TLS sobre FTP:${ftp_port} exitoso (FTPS explicito soportado)"
          else
            echo "::warning::No se pudo confirmar FTPS explicito con openssl"
          fi
          echo "::endgroup::"

          echo "::group::Prueba de login FTPS explicito con lftp"
          if timeout 20 lftp -u "$FTP_USERNAME","$FTP_PASSWORD" "ftp://${host}:${ftp_port}" -e "set cmd:fail-exit true; set net:timeout 8; set net:max-retries 1; set net:reconnect-interval-base 1; set ftp:ssl-force true; set ftp:ssl-protect-data true; set ssl:verify-certificate no; cls; bye" >/tmp/ftps-login.log 2>&1; then
            echo "::notice::Login FTPS explicito exitoso con credenciales actuales"
          else
            echo "::warning::Login FTPS explicito fallido con credenciales actuales"
            tail -n 20 /tmp/ftps-login.log || true
          fi
          echo "::endgroup::"

          echo "::group::Prueba de login SFTP con lftp"
          if timeout 20 lftp -u "$FTP_USERNAME","$FTP_PASSWORD" "sftp://${host}:22" -e "set cmd:fail-exit true; set sftp:auto-confirm yes; set net:timeout 8; set net:max-retries 1; set net:reconnect-interval-base 1; cls; bye" >/tmp/sftp-login.log 2>&1; then
            echo "::notice::Login SFTP exitoso con credenciales actuales"
          else
            echo "::warning::Login SFTP fallido con credenciales actuales"
            tail -n 20 /tmp/sftp-login.log || true
          fi
          echo "::endgroup::"

          transport=""
          connect_url=""
          lftp_transport_settings=""

          if timeout 20 lftp -u "$FTP_USERNAME","$FTP_PASSWORD" "sftp://${host}:22" -e "set cmd:fail-exit true; set sftp:auto-confirm yes; set net:timeout 8; set net:max-retries 1; set net:reconnect-interval-base 1; cls; bye" >/tmp/sftp-login.log 2>&1; then
            transport="sftp"
            connect_url="sftp://${host}:22"
            lftp_transport_settings="set sftp:auto-confirm yes;"
            echo "::notice::Seleccionado transporte seguro: SFTP"
          elif timeout 20 lftp -u "$FTP_USERNAME","$FTP_PASSWORD" "ftp://${host}:${ftp_port}" -e "set cmd:fail-exit true; set net:timeout 8; set net:max-retries 1; set net:reconnect-interval-base 1; set ftp:ssl-force true; set ftp:ssl-protect-data true; set ssl:verify-certificate no; cls; bye" >/tmp/ftps-login.log 2>&1; then
            transport="ftps-explicit"
            connect_url="ftp://${host}:${ftp_port}"
            lftp_transport_settings="set ftp:ssl-force true; set ftp:ssl-protect-data true; set ssl:verify-certificate no;"
            echo "::notice::Seleccionado transporte seguro: FTPS explicito"
          else
            echo "::error::No se pudo validar SFTP ni FTPS con las credenciales actuales. Se bloquea deploy inseguro por FTP plano."
            tail -n 20 /tmp/sftp-login.log || true
            tail -n 20 /tmp/ftps-login.log || true
            exit 1
          fi

          echo "FTP_TRANSPORT=${transport}" >> "$GITHUB_ENV"
          echo "FTP_CONNECT_URL=${connect_url}" >> "$GITHUB_ENV"
          echo "LFTP_TRANSPORT_SETTINGS=${lftp_transport_settings}" >> "$GITHUB_ENV"
          echo "::notice::FTP_CONNECT_URL=${connect_url}"

      - name: Deploy con lftp mirror (dist -> /public_html/crowdfunding) [IPv4 + excludes]
        shell: bash
        env:
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          set -euo pipefail
          echo "::notice::Conectando por $FTP_TRANSPORT a: $FTP_CONNECT_URL (destino: /public_html/crowdfunding)"
          echo "::notice::TamaÃ±o de dist/: $(du -sh dist/ | cut -f1)"

          lftp -u "$FTP_USERNAME","$FTP_PASSWORD" "$FTP_CONNECT_URL" -e "
          set cmd:fail-exit true;
          set net:timeout 180;
          set net:max-retries 10;
          set net:reconnect-interval-base 15;
          set net:reconnect-interval-multiplier 1;
          set net:idle 240;
          set ftp:passive-mode on;
          set ftp:prefer-epsv no;
          set ftp:sync-mode off;
          set dns:order inet;
          ${LFTP_TRANSPORT_SETTINGS}
          echo Iniciando sincronizacion...;
          mirror -R --delete --verbose --no-perms \
            --exclude-glob .ht_leame \
            --exclude-glob cgi-bin/ \
            dist/ /public_html/crowdfunding/;
          echo Proceso finalizado;
          bye
          "
          
          echo "::notice::Comando lftp ejecutado"

      - name: Deploy smoke check (opcional)
        if: ${{ vars.DEPLOY_HEALTHCHECK_URL != '' }}
        shell: bash
        env:
          DEPLOY_HEALTHCHECK_URL: ${{ vars.DEPLOY_HEALTHCHECK_URL }}
        run: |
          set -euo pipefail

          status_code="$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOY_HEALTHCHECK_URL")"
          if ! [[ "$status_code" =~ ^(200|301|302)$ ]]; then
            echo "::error::Smoke check fallÃ³ para $DEPLOY_HEALTHCHECK_URL (status: $status_code)"
            exit 1
          fi

          echo "::notice::Smoke check OK ($status_code): $DEPLOY_HEALTHCHECK_URL"

