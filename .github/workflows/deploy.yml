name: deploy-vue-to-ferozo

on:
  push:
    branches: [ main ]

concurrency:
  group: deploy-vue
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node (with npm cache)
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Validar config requerida
        shell: bash
        env:
          FTP_SERVER: ${{ vars.FTP_SERVER }}
          FTP_SERVER_IP: ${{ vars.FTP_SERVER_IP }}
          SITE_DOMAIN: ${{ vars.SITE_DOMAIN }}
          FTP_DIR: ${{ vars.FTP_DIR }}
          FTP_PORT: ${{ vars.FTP_PORT }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          set -euo pipefail

          for v in FTP_DIR FTP_USERNAME FTP_PASSWORD; do
            if [ -z "${!v:-}" ]; then
              echo "::error::Falta $v"
              exit 1
            fi
          done

          if [ -z "${FTP_SERVER:-}" ] && [ -z "${FTP_SERVER_IP:-}" ] && [ -z "${SITE_DOMAIN:-}" ]; then
            echo "::error::Necesitás al menos una de estas vars: FTP_SERVER o FTP_SERVER_IP o SITE_DOMAIN"
            exit 1
          fi

          if [[ "$FTP_DIR" != /* ]]; then
            echo "::error::FTP_DIR debe ser absoluto (ej: /public_html/crowdfunding)"
            exit 1
          fi

          # Default port
          echo "FTP_PORT=${FTP_PORT:-21}" >> "$GITHUB_ENV"

      - name: Resolver host efectivo (DNS) + fallback IP (depuración)
        shell: bash
        env:
          FTP_SERVER: ${{ vars.FTP_SERVER }}
          FTP_SERVER_IP: ${{ vars.FTP_SERVER_IP }}
          SITE_DOMAIN: ${{ vars.SITE_DOMAIN }}
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y dnsutils

          # Armamos lista de candidatos
          candidates=()

          [ -n "${FTP_SERVER:-}" ] && candidates+=("$FTP_SERVER")

          if [ -n "${SITE_DOMAIN:-}" ]; then
            # candidatos típicos en hostings
            candidates+=("ftp.${SITE_DOMAIN}")
            candidates+=("${SITE_DOMAIN}")
            candidates+=("www.${SITE_DOMAIN}")
          fi

          # Fallback IP al final (no requiere DNS)
          [ -n "${FTP_SERVER_IP:-}" ] && candidates+=("$FTP_SERVER_IP")

          echo "::group::Candidatos y diagnóstico DNS"
          for h in "${candidates[@]}"; do
            echo ""
            echo "==> $h"
            if [[ "$h" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]]; then
              echo "IP detectada (sin DNS)"
              continue
            fi
            nslookup "$h" || true
            dig +short "$h" A || true
            dig +short "$h" AAAA || true
          done
          echo "::endgroup::"

          chosen=""

          for h in "${candidates[@]}"; do
            if [[ "$h" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]]; then
              chosen="$h"
              echo "::notice::Usando IP fallback: $chosen"
              break
            fi

            if getent hosts "$h" >/dev/null 2>&1; then
              chosen="$h"
              echo "::notice::DNS OK, usando host: $chosen"
              break
            fi
          done

          if [ -z "$chosen" ]; then
            echo "::error::No se pudo resolver ningún host. Tomá el 'Servidor FTP' desde 'Acceso por FTP' del panel o cargá FTP_SERVER_IP."
            exit 1
          fi

          echo "FTP_HOST_EFFECTIVE=$chosen" >> "$GITHUB_ENV"
          echo "FTP_CONNECT_URL=ftp://${chosen}:${FTP_PORT}" >> "$GITHUB_ENV"
          echo "::notice::FTP_CONNECT_URL=ftp://${chosen}:${FTP_PORT}"

      - name: Preflight puerto (host:puerto)
        shell: bash
        run: |
          set -euo pipefail
          echo "Probando conectividad a $FTP_HOST_EFFECTIVE:$FTP_PORT"
          nc -zv "$FTP_HOST_EFFECTIVE" "$FTP_PORT"

      - name: Instalar dependencias
        run: npm ci

      - name: Build
        run: npm run build

      - name: Ensure dist/assets folder exists
        run: mkdir -p dist/assets

      - name: Ensure .htaccess for SPA (history mode)
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f "dist/.htaccess" ]; then
            cat > "dist/.htaccess" <<'EOF'
          RewriteEngine On
          RewriteRule ^index\.html$ - [L]
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteRule . /index.html [L]
          EOF
          fi

      - name: Deploy con lftp mirror (dist -> FTP_DIR)
        shell: bash
        env:
          FTP_DIR: ${{ vars.FTP_DIR }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y lftp

          lftp -u "$FTP_USERNAME","$FTP_PASSWORD" "$FTP_CONNECT_URL" <<EOF
          set cmd:fail-exit true
          set net:timeout 30
          set net:max-retries 2
          set ftp:passive-mode on

          mkdir -p "$FTP_DIR"
          mirror -R --delete --only-newer --verbose --no-perms --parallel=2 dist/ "$FTP_DIR/"
          bye
          EOF
