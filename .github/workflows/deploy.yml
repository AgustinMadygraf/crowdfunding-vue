name: deploy-vue-to-ferozo

on:
  push:
    branches: [ main ]

concurrency:
  group: deploy-vue
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node (with npm cache)
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Validar config requerida
        shell: bash
        env:
          FTP_SERVER: ${{ vars.FTP_SERVER }}
          FTP_SERVER_IP: ${{ vars.FTP_SERVER_IP }}
          FTP_DIR: ${{ vars.FTP_DIR }}
          FTP_PORT: ${{ vars.FTP_PORT }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          VITE_CHATWOOT_TOKEN: ${{ secrets.VITE_CHATWOOT_TOKEN }}
          VITE_CHATWOOT_BASE_URL: ${{ secrets.VITE_CHATWOOT_BASE_URL }}
          VITE_CHATWOOT_INBOX_IDENTIFIER: ${{ secrets.VITE_CHATWOOT_INBOX_IDENTIFIER }}
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
          VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_GOOGLE_CLIENT_ID }}
        run: |
          set -euo pipefail

          # Validar variables obligatorias
          for v in FTP_DIR FTP_USERNAME FTP_PASSWORD VITE_CHATWOOT_TOKEN VITE_CHATWOOT_BASE_URL VITE_CHATWOOT_INBOX_IDENTIFIER VITE_API_BASE_URL VITE_GOOGLE_CLIENT_ID; do
            if [ -z "${!v:-}" ]; then
              echo "::error::Falta $v (requerido para producción)"
              exit 1
            fi
          done

          echo "::notice::Variables obligatorias validadas ✓"

          if [ -z "${FTP_SERVER:-}" ]; then
            echo "::error::Falta FTP_SERVER (var). Ej: vps-5455262-x.dattaweb.com"
            exit 1
          fi

          if [[ "$FTP_DIR" != /* ]]; then
            echo "::error::FTP_DIR debe ser absoluto (ej: /public_html/crowdfunding)"
            exit 1
          fi

          echo "FTP_PORT=${FTP_PORT:-21}" >> "$GITHUB_ENV"

      - name: Resolver IP (forzar IPv4) y armar URL de conexión
        shell: bash
        env:
          FTP_SERVER: ${{ vars.FTP_SERVER }}
          FTP_SERVER_IP: ${{ vars.FTP_SERVER_IP }}
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y dnsutils

          ip4="$(dig +short "$FTP_SERVER" A | head -n 1 || true)"
          if [ -z "$ip4" ] && [ -n "${FTP_SERVER_IP:-}" ]; then
            ip4="$FTP_SERVER_IP"
            echo "::notice::No encontré A record; usando FTP_SERVER_IP fallback: $ip4"
          fi

          if [ -z "$ip4" ]; then
            echo "::error::No pude obtener IPv4 (A). Cargá FTP_SERVER_IP (ej: 200.58.103.24)."
            exit 1
          fi

          echo "FTP_IPv4_EFFECTIVE=$ip4" >> "$GITHUB_ENV"
          echo "FTP_CONNECT_URL=ftp://${ip4}:${FTP_PORT}" >> "$GITHUB_ENV"
          echo "::notice::FTP_CONNECT_URL=ftp://${ip4}:${FTP_PORT}"

      - name: Preflight puerto 21 (IPv4)
        shell: bash
        run: |
          set -euo pipefail
          nc -zv "$FTP_IPv4_EFFECTIVE" "$FTP_PORT"

      - name: Instalar dependencias
        run: npm ci

      - name: Build
        env:
          VITE_CHATWOOT_TOKEN: ${{ secrets.VITE_CHATWOOT_TOKEN }}
          VITE_CHATWOOT_BASE_URL: ${{ secrets.VITE_CHATWOOT_BASE_URL }}
          VITE_CHATWOOT_INBOX_IDENTIFIER: ${{ secrets.VITE_CHATWOOT_INBOX_IDENTIFIER }}
          VITE_CHATWOOT_HMAC_TOKEN: ${{ secrets.VITE_CHATWOOT_HMAC_TOKEN }}
          VITE_CHATWOOT_SDK_INTEGRITY: ${{ secrets.VITE_CHATWOOT_SDK_INTEGRITY }}
          VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_GOOGLE_CLIENT_ID }}
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
          VITE_SITE_URL: ${{ secrets.VITE_SITE_URL }}
          VITE_MERCADOPAGO_PUBLIC_KEY: ${{ secrets.VITE_MERCADOPAGO_PUBLIC_KEY }}
          VITE_SENTRY_DSN: ${{ secrets.VITE_SENTRY_DSN }}
        run: npm run build

      - name: Ensure dist/assets folder exists
        run: mkdir -p dist/assets

      - name: Ensure .htaccess for SPA (history mode)
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f "dist/.htaccess" ]; then
            cat > "dist/.htaccess" <<'EOF'
          RewriteEngine On
          RewriteRule ^index\.html$ - [L]
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteRule . /index.html [L]
          EOF
          fi

      - name: Deploy con lftp mirror (dist -> FTP_DIR) [IPv4 + excludes]
        shell: bash
        env:
          FTP_DIR: ${{ vars.FTP_DIR }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y lftp

          # Debug: muestra la URL de conexión (sin credenciales)
          echo "::notice::Conectando a: $FTP_CONNECT_URL (destino: $FTP_DIR)"
          echo "::notice::Tamaño de dist/: $(du -sh dist/ | cut -f1)"

          lftp -u "$FTP_USERNAME","$FTP_PASSWORD" "$FTP_CONNECT_URL" <<EOF
          set cmd:fail-exit true
          set net:timeout 90
          set net:max-retries 5
          set net:reconnect-delay 5
          set ftp:passive-mode on
          set ftp:ssl-allow no
          set ftp:prefer-epsv no
          set mirror:use-pget-n 4

          # Validar conexión inicial
          echo "Validando conexión FTP..."
          ls -la / 2>/dev/null | head -5 || echo "Listado fallido pero continuando"

          # Usar mirror sin cd previo (ruta absoluta)
          echo "Sincronizando dist -> $FTP_DIR ..."
          mirror -R --delete --only-newer --verbose --skip-nlist \
            --exclude-glob .ht_leame \
            --exclude-glob cgi-bin/ \
            --exclude-glob cgi-bin/** \
            dist/ "$FTP_DIR/"

          echo "Deploy completado"
          bye
          EOF
          
          echo "::notice::Deploy finalizado sin errores"
