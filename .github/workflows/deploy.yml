name: deploy-vue-to-ferozo

on:
  push:
    branches: [ main ]

concurrency:
  group: deploy-vue
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node (with npm cache)
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Validar config requerida
        shell: bash
        env:
          FTP_SERVER: ${{ vars.FTP_SERVER }}
          FTP_SERVER_IP: ${{ vars.FTP_SERVER_IP }}
          FTP_DIR: ${{ vars.FTP_DIR }}
          FTP_PORT: ${{ vars.FTP_PORT }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          set -euo pipefail

          for v in FTP_DIR FTP_USERNAME FTP_PASSWORD; do
            if [ -z "${!v:-}" ]; then
              echo "::error::Falta $v"
              exit 1
            fi
          done

          if [ -z "${FTP_SERVER:-}" ]; then
            echo "::error::Falta FTP_SERVER (var). Ej: vps-5455262-x.dattaweb.com"
            exit 1
          fi

          if [[ "$FTP_DIR" != /* ]]; then
            echo "::error::FTP_DIR debe ser absoluto (ej: /public_html/crowdfunding)"
            exit 1
          fi

          echo "FTP_PORT=${FTP_PORT:-21}" >> "$GITHUB_ENV"

      - name: Resolver IP (forzar IPv4) y armar URL de conexión
        shell: bash
        env:
          FTP_SERVER: ${{ vars.FTP_SERVER }}
          FTP_SERVER_IP: ${{ vars.FTP_SERVER_IP }}
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y dnsutils

          echo "::group::DNS (A/AAAA) para $FTP_SERVER"
          echo -n "A: "; dig +short "$FTP_SERVER" A || true
          echo -n "AAAA: "; dig +short "$FTP_SERVER" AAAA || true
          echo "::endgroup::"

          # Preferimos IPv4:
          ip4="$(dig +short "$FTP_SERVER" A | head -n 1 || true)"

          # Si no hay A, usamos fallback explícito si existe
          if [ -z "$ip4" ] && [ -n "${FTP_SERVER_IP:-}" ]; then
            ip4="$FTP_SERVER_IP"
            echo "::notice::No encontré A record; usando FTP_SERVER_IP fallback: $ip4"
          fi

          if [ -z "$ip4" ]; then
            echo "::error::No pude obtener IPv4 (A). Cargá FTP_SERVER_IP con 200.58.103.24"
            exit 1
          fi

          echo "FTP_HOST_EFFECTIVE=$FTP_SERVER" >> "$GITHUB_ENV"
          echo "FTP_IPv4_EFFECTIVE=$ip4" >> "$GITHUB_ENV"
          echo "FTP_CONNECT_URL=ftp://${ip4}:${FTP_PORT}" >> "$GITHUB_ENV"
          echo "::notice::FTP_CONNECT_URL=ftp://${ip4}:${FTP_PORT}"

      - name: Preflight puerto 21 (IPv4)
        shell: bash
        run: |
          set -euo pipefail
          echo "Probando conectividad IPv4 a $FTP_IPv4_EFFECTIVE:$FTP_PORT"
          nc -zv "$FTP_IPv4_EFFECTIVE" "$FTP_PORT"

      - name: Instalar dependencias
        run: npm ci

      - name: Build
        run: npm run build

      - name: Ensure dist/assets folder exists
        run: mkdir -p dist/assets

      - name: Ensure .htaccess for SPA (history mode)
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f "dist/.htaccess" ]; then
            cat > "dist/.htaccess" <<'EOF'
          RewriteEngine On
          RewriteRule ^index\.html$ - [L]
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteRule . /index.html [L]
          EOF
          fi

      - name: Deploy con lftp mirror (dist -> FTP_DIR) [IPv4]
        shell: bash
        env:
          FTP_DIR: ${{ vars.FTP_DIR }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y lftp

          lftp -u "$FTP_USERNAME","$FTP_PASSWORD" "$FTP_CONNECT_URL" <<EOF
          set cmd:fail-exit true
          set net:timeout 30
          set net:max-retries 2
          set ftp:passive-mode on
          set ftp:ssl-allow no

          mkdir -p "$FTP_DIR"
          mirror -R --delete --only-newer --verbose --no-perms --parallel=2 dist/ "$FTP_DIR/"
          bye
          EOF
